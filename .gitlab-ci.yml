image:
  name: mikesupertrampster/packer

stages:
- tag-source
- build-base

tag-source:
  stage: tag-source
  only:
  - master
  script:
    - export GIT_SSH_COMMAND="ssh -i ~/.ssh/gitlab_deploy -o 'StrictHostKeyChecking no'"
    - mkdir -p ~/.ssh && echo "${GITLAB_DEPLOY_KEY}" | base64 -d > ~/.ssh/gitlab_deploy && chmod 200  ~/.ssh/gitlab_deploy
    - git config --global user.email "Gitlab CI"
    - git config --global user.name "Gitlab CI"
    - .scripts/gen-semver.py > semver
  artifacts:
    paths:
      - semver

build-base:
  stage: build-base
  variables:
    role: base
  only:
  - master
#    changes:
#      - ansible/roles/base/**/*
#      - ansible/roles/hardening/**/*
  script:
    - export VERSION_NO=$(cat semver)
    - packer build packer/${role}.json