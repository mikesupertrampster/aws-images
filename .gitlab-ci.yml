image:
  name: mikesupertrampster/packer

stages:
- tag-source
- build-base

tag-source:
  stage: tag-source
  only:
  - master
  script:
    - mkdir -p ~/.ssh && echo "${GITHUB_DEPLOY_KEY}" > ~/.ssh/id_rsa && chmod 200  ~/.ssh/id_rsa
    - echo -e "Host *\n    StrictHostKeyChecking no" > ~/.ssh/config
    - git remote set-url origin ${GITHUB_SSH_URL}
    - git config --global user.email "Gitlab CI"
    - git config --global user.name "Gitlab CI"
    - ssh || exit 0
    - .scripts/gen-semver.py > semver
  artifacts:
    paths:
      - semver

build-base:
  stage: build-base
  variables:
    role: base
  only:
  - master
#    changes:
#      - ansible/roles/base/**/*
#      - ansible/roles/hardening/**/*
  script:
    - export VERSION_NO=$(cat semver)
    - packer build packer/${role}.json